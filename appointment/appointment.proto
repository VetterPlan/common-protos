syntax = "proto3";

package appointment;

import "google/protobuf/timestamp.proto";

// ═══════════════════════════════════════════════════════════════════════════
// APPOINTMENT SERVICE
//
// Core business service for VeterPlan's veterinary home visits marketplace.
// Manages the full appointment lifecycle from request to completion,
// including vet matching, state machine transitions, payments, and reviews.
//
// Depends on: Auth, Profile, Pet, VetCertification, Payment, Geolocation,
//             Notification services.
// ═══════════════════════════════════════════════════════════════════════════

service AppointmentService {
  // ─── LIFECYCLE ───

  // Client requests a new appointment (creates REQUESTED state)
  rpc RequestAppointment (RequestAppointmentRequest) returns (AppointmentResponse);

  // Vet accepts an appointment (REQUESTED -> ACCEPTED, first-come-first-served)
  rpc AcceptAppointment (AcceptAppointmentRequest) returns (AppointmentResponse);

  // Update appointment status (EN_ROUTE, COMPLETED, etc.)
  rpc UpdateAppointmentStatus (UpdateAppointmentStatusRequest) returns (AppointmentResponse);

  // Vet confirms arrival with 6-digit PIN (ARRIVED -> IN_PROGRESS)
  rpc ConfirmArrival (ConfirmArrivalRequest) returns (AppointmentResponse);

  // Cancel an appointment (client, vet, or system)
  rpc CancelAppointment (CancelAppointmentRequest) returns (AppointmentResponse);

  // ─── QUERIES ───

  // Get a single appointment by ID
  rpc GetAppointment (GetAppointmentRequest) returns (AppointmentResponse);

  // Get appointments for a client (with optional status filter)
  rpc GetClientAppointments (GetClientAppointmentsRequest) returns (AppointmentsResponse);

  // Get appointments for a vet (with optional status filter)
  rpc GetVetAppointments (GetVetAppointmentsRequest) returns (AppointmentsResponse);

  // ─── MATCHING ───

  // Find available vets for a service at a location and time
  rpc GetAvailableVets (GetAvailableVetsRequest) returns (AvailableVetsResponse);

  // ─── NEW: Appointment Modes + Slots ───

  // Get vet's appointments for a specific date (called by Profile Service)
  rpc GetVetAppointmentsForDate (GetVetAppointmentsForDateRequest) returns (GetVetAppointmentsForDateResponse);

  // Get next available calculated slots (MVP aggregator)
  rpc GetNextAvailableSlots (GetNextAvailableSlotsRequest) returns (GetNextAvailableSlotsResponse);

  // Get pet's appointment history (for follow-up recommendations)
  rpc GetPetAppointmentHistory (GetPetAppointmentHistoryRequest) returns (GetPetAppointmentHistoryResponse);

  // ─── RECOMMENDATIONS ───

  // Get vaccine recommendations for a pet (overdue, upcoming, suggested)
  rpc GetVaccineRecommendations (GetVaccineRecommendationsRequest) returns (GetVaccineRecommendationsResponse);

  // Get follow-up recommendations based on recent appointment history
  rpc GetFollowUpRecommendations (GetFollowUpRecommendationsRequest) returns (GetFollowUpRecommendationsResponse);
}

// ═══════════════════════════════════════════════════════════════════════════
// ENUMS
// ═══════════════════════════════════════════════════════════════════════════

enum AppointmentStatus {
  APPOINTMENT_STATUS_UNSPECIFIED = 0;
  APPOINTMENT_STATUS_REQUESTED = 1;
  APPOINTMENT_STATUS_ACCEPTED = 2;
  APPOINTMENT_STATUS_EN_ROUTE = 3;
  APPOINTMENT_STATUS_ARRIVED = 4;
  APPOINTMENT_STATUS_IN_PROGRESS = 5;
  APPOINTMENT_STATUS_COMPLETED = 6;
  APPOINTMENT_STATUS_CANCELLED = 7;
  APPOINTMENT_STATUS_NO_SHOW = 8;
  APPOINTMENT_STATUS_REJECTED = 9;
  APPOINTMENT_STATUS_EXPIRED = 10;
}

enum ServiceType {
  SERVICE_TYPE_UNSPECIFIED = 0;
  SERVICE_TYPE_CONSULTATION = 1;
  SERVICE_TYPE_VACCINATION = 2;
  SERVICE_TYPE_DEWORMING = 3;
  SERVICE_TYPE_FOLLOW_UP = 4;
  SERVICE_TYPE_MEDICAL_CERTIFICATE = 5;
  SERVICE_TYPE_ULTRASOUND = 6;
  SERVICE_TYPE_ELECTROCARDIOGRAM = 7;
}

enum CancellationReason {
  CANCELLATION_REASON_UNSPECIFIED = 0;
  CANCELLATION_REASON_CLIENT_REQUEST = 1;
  CANCELLATION_REASON_VET_UNAVAILABLE = 2;
  CANCELLATION_REASON_WEATHER = 3;
  CANCELLATION_REASON_PET_EMERGENCY = 4;
  CANCELLATION_REASON_SCHEDULING_CONFLICT = 5;
  CANCELLATION_REASON_NO_RESPONSE = 6;
  CANCELLATION_REASON_SYSTEM_TIMEOUT = 7;
  CANCELLATION_REASON_ADMIN_ACTION = 8;
  CANCELLATION_REASON_OTHER = 9;
}

enum StatusChangeReason {
  STATUS_CHANGE_REASON_UNSPECIFIED = 0;
  STATUS_CHANGE_REASON_CLIENT_REQUESTED = 1;
  STATUS_CHANGE_REASON_VET_ACCEPTED = 2;
  STATUS_CHANGE_REASON_VET_REJECTED = 3;
  STATUS_CHANGE_REASON_VET_EN_ROUTE = 4;
  STATUS_CHANGE_REASON_GEOFENCE_ARRIVAL = 5;
  STATUS_CHANGE_REASON_PIN_CONFIRMED = 6;
  STATUS_CHANGE_REASON_VET_STARTED = 7;
  STATUS_CHANGE_REASON_VET_COMPLETED = 8;
  STATUS_CHANGE_REASON_CLIENT_CANCELLED = 9;
  STATUS_CHANGE_REASON_VET_CANCELLED = 10;
  STATUS_CHANGE_REASON_SYSTEM_EXPIRED = 11;
  STATUS_CHANGE_REASON_SYSTEM_NO_SHOW = 12;
  STATUS_CHANGE_REASON_ADMIN_OVERRIDE = 13;
  STATUS_CHANGE_REASON_OTHER = 14;
}

enum UrgencyLevel {
  URGENCY_LEVEL_UNSPECIFIED = 0;
  URGENCY_LEVEL_ROUTINE = 1;
  URGENCY_LEVEL_SOON = 2;
  URGENCY_LEVEL_URGENT = 3;
  URGENCY_LEVEL_EMERGENCY = 4;
}

// ═══════════════════════════════════════════════════════════════════════════
// MESSAGES - Core Entities
// ═══════════════════════════════════════════════════════════════════════════

message Appointment {
  string id = 1;

  // Parties
  string client_profile_id = 2;
  string vet_profile_id = 3;        // Empty until accepted
  repeated string pet_ids = 4;

  // Service
  ServiceType service_type = 5;
  UrgencyLevel urgency = 6;
  int32 estimated_duration_minutes = 7;

  // Status
  AppointmentStatus status = 8;
  string confirmation_code = 9;     // 6-digit PIN for arrival confirmation

  // Scheduling
  string scheduled_date = 10;       // ISO 8601 date (YYYY-MM-DD)
  string scheduled_time_start = 11; // ISO 8601 datetime
  string scheduled_time_end = 12;   // ISO 8601 datetime

  // Location (denormalized from profile address)
  string address_id = 13;
  double address_lat = 14;
  double address_lng = 15;
  string address_text = 16;

  // Notes
  string client_notes = 17;
  string vet_notes = 18;

  // Payment
  double estimated_price = 19;
  double final_price = 20;
  string currency = 21;
  string payment_preauth_id = 22;

  // Cancellation
  CancellationReason cancellation_reason = 23;
  string cancelled_by = 24;

  // Timestamps
  google.protobuf.Timestamp created_at = 25;
  google.protobuf.Timestamp updated_at = 26;
  google.protobuf.Timestamp accepted_at = 27;
  google.protobuf.Timestamp en_route_at = 28;
  google.protobuf.Timestamp arrived_at = 29;
  google.protobuf.Timestamp started_at = 30;
  google.protobuf.Timestamp completed_at = 31;
  google.protobuf.Timestamp expires_at = 32;

  // Embedded relations (when requested)
  repeated StatusHistoryEntry status_history = 33;

  // NEW: Appointment mode fields
  string appointment_mode = 34;        // on_demand, flex_window, scheduled
  string time_window_start = 35;       // ISO 8601 datetime
  string time_window_end = 36;         // ISO 8601 datetime
  string preferred_vet_id = 37;
  string service_metadata = 38;        // JSON string
}

message StatusHistoryEntry {
  string id = 1;
  string appointment_id = 2;
  AppointmentStatus previous_status = 3;
  AppointmentStatus new_status = 4;
  StatusChangeReason reason = 5;
  string reason_details = 6;
  string changed_by = 7;            // "CLIENT" | "VET" | "SYSTEM" or UUID
  google.protobuf.Timestamp changed_at = 8;
}

message AvailableVet {
  string vet_profile_id = 1;
  string display_name = 2;
  string avatar_url = 3;
  double distance_km = 4;
  double rating = 5;
  int32 review_count = 6;
  double estimated_price = 7;
  int32 estimated_arrival_minutes = 8;
  repeated string certifications = 9;
  repeated string specialties = 10;
  double score = 11;
  string price_notes = 12;
  bool is_preferred = 13;              // true if preferred_vet_id matches
}

message ServiceCatalogItem {
  string id = 1;
  string name = 2;
  string slug = 3;
  string description = 4;
  ServiceType service_type = 5;
  double base_price_min = 6;
  double base_price_max = 7;
  int32 duration_minutes_est = 8;
  bool is_active = 9;
}

// ═══════════════════════════════════════════════════════════════════════════
// MESSAGES - Requests
// ═══════════════════════════════════════════════════════════════════════════

// ─── Lifecycle ───

message RequestAppointmentRequest {
  string client_profile_id = 1;
  repeated string pet_ids = 2;
  ServiceType service_type = 3;
  UrgencyLevel urgency = 4;
  string scheduled_date = 5;           // ISO 8601 date
  string scheduled_time_start = 6;     // ISO 8601 datetime
  int32 estimated_duration_minutes = 7;
  string address_id = 8;
  double address_lat = 9;
  double address_lng = 10;
  string address_text = 11;
  string client_notes = 12;
  // NEW FIELDS for appointment modes:
  string appointment_mode = 13;        // on_demand, flex_window, scheduled
  string time_window_start = 14;       // ISO 8601 UTC (required for FLEX_WINDOW/SCHEDULED)
  string time_window_end = 15;         // ISO 8601 UTC (required for FLEX_WINDOW/SCHEDULED)
  string preferred_vet_id = 16;        // Optional: "I want this specific vet"
  string service_metadata = 17;        // JSON string with subtype info
}

message AcceptAppointmentRequest {
  string appointment_id = 1;
  string vet_profile_id = 2;
  double estimated_price = 3;
  int32 estimated_arrival_minutes = 4;
  string vet_notes = 5;
}

message UpdateAppointmentStatusRequest {
  string appointment_id = 1;
  AppointmentStatus new_status = 2;
  StatusChangeReason reason = 3;
  string reason_details = 4;
  string changed_by = 5;
  // Optional fields for specific transitions
  string vet_notes = 6;
  double final_price = 7;
}

message ConfirmArrivalRequest {
  string appointment_id = 1;
  string confirmation_code = 2;       // 6-digit PIN
}

message CancelAppointmentRequest {
  string appointment_id = 1;
  CancellationReason reason = 2;
  string reason_details = 3;
  string cancelled_by = 4;            // user_id or "SYSTEM"
}

// ─── Queries ───

message GetAppointmentRequest {
  string appointment_id = 1;
  bool include_status_history = 2;
}

message GetClientAppointmentsRequest {
  string client_profile_id = 1;
  AppointmentStatus status_filter = 2;  // UNSPECIFIED = all statuses
  int32 limit = 3;
  int32 offset = 4;
}

message GetVetAppointmentsRequest {
  string vet_profile_id = 1;
  AppointmentStatus status_filter = 2;
  int32 limit = 3;
  int32 offset = 4;
}

// ─── Matching ───

message GetAvailableVetsRequest {
  ServiceType service_type = 1;
  double address_lat = 2;
  double address_lng = 3;
  string scheduled_date = 4;           // ISO 8601 date
  string scheduled_time_start = 5;     // ISO 8601 datetime
  UrgencyLevel urgency = 6;
  string pet_species = 7;             // For certification filtering
  double radius_km = 8;               // Search radius (default: 15km)
  int32 max_results = 9;              // Max vets to return (default: 5)
  // NEW FIELDS for appointment modes:
  string appointment_mode = 10;        // on_demand, flex_window, scheduled
  string time_window_start = 11;       // ISO 8601 UTC
  string time_window_end = 12;         // ISO 8601 UTC
  string preferred_vet_id = 13;        // Optional: boost in ranking
}

// ═══════════════════════════════════════════════════════════════════════════
// MESSAGES - Responses
// ═══════════════════════════════════════════════════════════════════════════

message AppointmentResponse {
  Appointment appointment = 1;
}

message AppointmentsResponse {
  repeated Appointment appointments = 1;
  int32 total_count = 2;
}

message AvailableVetsResponse {
  repeated AvailableVet vets = 1;
  int32 total_count = 2;
  double search_radius_km = 3;
}

// ═══════════════════════════════════════════════════════════════════════════
// NEW MESSAGES — Vet Appointments for Date (inter-service)
// ═══════════════════════════════════════════════════════════════════════════

message GetVetAppointmentsForDateRequest {
  string vet_profile_id = 1;
  string date = 2;                     // "2026-02-15"
}

message GetVetAppointmentsForDateResponse {
  repeated VetAppointmentSlot appointments = 1;
}

message VetAppointmentSlot {
  string appointment_id = 1;
  string time_window_start = 2;        // ISO 8601 UTC
  string time_window_end = 3;          // ISO 8601 UTC
  string status = 4;                   // REQUESTED, ACCEPTED, etc.
  string service_type = 5;
}

// ═══════════════════════════════════════════════════════════════════════════
// NEW MESSAGES — Next Available Slots (MVP calculated slots)
// ═══════════════════════════════════════════════════════════════════════════

message GetNextAvailableSlotsRequest {
  string service_type = 1;             // CONSULTATION, VACCINATION, etc.
  double address_lat = 2;              // Client location
  double address_lng = 3;
  int32 hours_ahead = 4;              // How many hours ahead to search (default 48)
  string service_metadata = 5;        // JSON string with subtype info (passthrough, does not affect slot logic)
}

message GetNextAvailableSlotsResponse {
  repeated DaySlots days = 1;                  // Grouped by day
  int32 total_vets_in_area = 2;
  int32 service_duration_minutes = 3;          // Duration of the service
}

message DaySlots {
  string date = 1;                     // "2026-02-15"
  string day_label = 2;               // "Hoy", "Mañana", "Sábado 15"
  repeated CalculatedSlot slots = 3;
}

message CalculatedSlot {
  string slot_id = 1;                  // UUID for this slot
  string start_time = 2;              // "10:00" (local Colombia time)
  string end_time = 3;                // "11:00" (end of service visible to client)
  string start_time_utc = 4;          // ISO 8601 UTC
  string end_time_utc = 5;            // ISO 8601 UTC (includes buffer for overlap)
  int32 available_vet_count = 6;
  double lowest_price = 7;
  double highest_price = 8;
  repeated SlotVetPreview vets = 9;
}

message SlotVetPreview {
  string vet_profile_id = 1;
  string name = 2;
  string avatar_initials = 3;
  double rating = 4;
  int32 review_count = 5;
  double price = 6;
  int32 eta_minutes = 7;
}

// ═══════════════════════════════════════════════════════════════════════════
// NEW MESSAGES — Pet Appointment History (for follow-up recommendations)
// ═══════════════════════════════════════════════════════════════════════════

message GetPetAppointmentHistoryRequest {
  string pet_id = 1;
  int32 days_back = 2;                // default 90
}

message GetPetAppointmentHistoryResponse {
  repeated PetAppointmentSummary appointments = 1;
}

message PetAppointmentSummary {
  string appointment_id = 1;
  string service_type = 2;
  string vet_profile_id = 3;
  string vet_name = 4;
  string status = 5;
  string completed_at = 6;
  string service_metadata = 7;         // JSON string
}

// ═══════════════════════════════════════════════════════════════════════════
// NEW MESSAGES — Vaccine Recommendations
// ═══════════════════════════════════════════════════════════════════════════

message GetVaccineRecommendationsRequest {
  string pet_id = 1;                   // UUID of the pet
  string species = 2;                  // "DOG" or "CAT" (to filter catalog)
}

message VaccineRecommendation {
  string vaccine_type = 1;             // "DOG_RABIA", "CAT_TRIPLE_FELINA", etc.
  string vaccine_name = 2;             // "Antirrábica"
  string category = 3;                 // "OVERDUE", "UPCOMING", "SUGGESTED"
  int32 days_relative = 4;             // Negative if overdue (-15), positive if upcoming (12), 0 if suggested
  string last_administered = 5;        // ISO 8601 or empty if never
  string next_due_date = 6;            // ISO 8601 or empty if not applicable
  string display_text = 7;             // "Venció hace 15 días" / "Vence en 12 días" / "Sin registro previo"
}

message GetVaccineRecommendationsResponse {
  repeated VaccineRecommendation recommendations = 1;
  bool has_vaccination_history = 2;    // false if the pet has never been vaccinated
  string pet_name = 3;                 // For message "No encontramos historial para {pet_name}"
}

// ═══════════════════════════════════════════════════════════════════════════
// NEW MESSAGES — Follow-Up Recommendations
// ═══════════════════════════════════════════════════════════════════════════

message GetFollowUpRecommendationsRequest {
  string pet_id = 1;
}

message FollowUpRecommendation {
  string followup_type = 1;            // "POST_CONSULTATION", etc.
  string name = 2;                     // "Control post-consulta"
  string description = 3;              // "Con Dra. María López — hace 8 días"
  string category = 4;                 // "RECOMMENDED" or "GENERIC"
  string related_appointment_id = 5;   // UUID of the previous appointment (if applicable)
  string related_vet_id = 6;           // UUID of the vet (for preferred_vet_id)
  string related_vet_name = 7;         // Vet name (if applicable)
}

message GetFollowUpRecommendationsResponse {
  repeated FollowUpRecommendation recommendations = 1;
  bool has_recent_appointments = 2;
}
