syntax = "proto3";

package auth;

service AuthService {
  // Authentication
  rpc Login (LoginRequest) returns (LoginResponse);
  rpc RefreshToken (RefreshTokenRequest) returns (LoginResponse);
  rpc ValidateToken (ValidateTokenRequest) returns (ValidateTokenResponse);
  rpc Register (RegisterRequest) returns (RegisterResponse);
  rpc VerifyEmail (VerifyEmailRequest) returns (VerifyEmailResponse);
  rpc SendOtp(SendOtpRequest) returns (SendOtpResponse);
  rpc VerifyOtp(VerifyOtpRequest) returns (VerifyOtpResponse);
  
  // Role Management (NEW - Sprint 3)
  rpc AssignRole (AssignRoleRequest) returns (AssignRoleResponse);
  rpc GetUserRoles (GetUserRolesRequest) returns (GetUserRolesResponse);
  rpc RemoveRole (RemoveRoleRequest) returns (RemoveRoleResponse);
}

message LoginRequest {
  string username = 1;
  string password = 2;
}

message RegisterRequest {
    string username = 1;
    string password = 2;
    string email = 3;
    string phone = 4;
}

message RegisterResponse {
    string message = 1;
}

message LoginResponse {
  string accessToken = 1;
  string refreshToken = 2;
}

message RefreshTokenRequest {
  string refreshToken = 1;
}

message ValidateTokenRequest {
  string token = 1;
}

message ValidateTokenResponse {
  bool valid = 1;
  string user_id = 2;
  string name = 3;
  string email = 4;
  repeated string roles = 5;  // CHANGED: from string to repeated string
  string user_type = 6;       // NEW: "client", "vet", "both", or "admin"
  bool is_email_verified = 7; // NEW: renamed from is_verified
}

message VerifyEmailRequest {
  string token = 1;
}

message VerifyEmailResponse {
  bool success = 1;
  string message = 2;
}

message SendOtpRequest {
  string phoneNumber = 1;
}

message SendOtpResponse {
  bool success = 1;
  string message = 2;
  string expiresAt = 3;
}

message VerifyOtpRequest {
  string phoneNumber = 1;
  string otpCode = 2;
}

message VerifyOtpResponse {
  bool success = 1;
  string message = 2;
}

// ============================================================================
// ROLE MANAGEMENT MESSAGES (NEW - Sprint 3)
// ============================================================================

message AssignRoleRequest {
  string user_id = 1;         // UUID of user to assign role to
  string role_slug = 2;        // "client", "vet", or "admin"
  string assigned_by = 3;      // UUID of admin assigning the role
  optional string reason = 4;  // Optional reason for audit trail
}

message AssignRoleResponse {
  bool success = 1;
  string message = 2;
  RoleAssignment assignment = 3;
}

message GetUserRolesRequest {
  string user_id = 1;
}

message GetUserRolesResponse {
  repeated RoleAssignment roles = 1;
  string user_type = 2;  // Computed: "client", "vet", "both", "admin"
}

message RemoveRoleRequest {
  string user_id = 1;
  string role_slug = 2;
  string removed_by = 3;
  optional string reason = 4;
}

message RemoveRoleResponse {
  bool success = 1;
  string message = 2;
}

message RoleAssignment {
  string role_id = 1;
  string role_slug = 2;
  string role_name = 3;
  string assigned_at = 4;  // ISO 8601 timestamp
  string assigned_by = 5;  // UUID of assigner (if available)
}