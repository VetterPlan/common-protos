syntax = "proto3";

package payment;

import "google/protobuf/timestamp.proto";

// ═══════════════════════════════════════════════════════════════════════════
// PAYMENT SERVICE
//
// Manages payments, wallets, refunds, payouts, and payment methods for
// VeterPlan's veterinary home visits marketplace.
//
// Integrates with Wompi (Colombia) for card/Nequi processing.
// Provides wallet functionality for instant refunds and split payments.
//
// Depends on: Appointment Service (payment lifecycle triggers)
// Called by: Appointment Service, API Gateway, Admin
// ═══════════════════════════════════════════════════════════════════════════

service PaymentService {
  // ─── PAYMENT LIFECYCLE (10 RPCs) ───

  // Create a PENDING payment when appointment is requested. No money moves.
  rpc CreatePayment (CreatePaymentRequest) returns (PaymentResponse);

  // Pre-authorize payment (Wompi preauth + wallet HOLD). Called when vet accepts.
  rpc AuthorizePayment (AuthorizePaymentRequest) returns (PaymentResponse);

  // Capture authorized payment. Called when appointment completes.
  rpc CapturePayment (CapturePaymentRequest) returns (PaymentResponse);

  // Void/release pre-authorization without charging. Called on cancel/expire pre-capture.
  rpc VoidPayment (VoidPaymentRequest) returns (PaymentResponse);

  // Process refund with client-chosen destination (WALLET/GATEWAY/MIXED).
  rpc RefundPayment (RefundPaymentRequest) returns (RefundResponse);

  // Charge no-show fee (30% capture + 70% void + partial refund).
  rpc ChargeNoShowFee (ChargeNoShowFeeRequest) returns (PaymentResponse);

  // Add tip post-appointment. Goes to vet wallet.
  rpc AddTip (AddTipRequest) returns (PaymentResponse);

  // Get payment by ID.
  rpc GetPayment (GetPaymentRequest) returns (PaymentResponse);

  // Get payment by appointment ID.
  rpc GetPaymentByAppointment (GetPaymentByAppointmentRequest) returns (PaymentResponse);

  // Get refunds for a payment.
  rpc GetRefunds (GetRefundsRequest) returns (RefundsResponse);

  // ─── WALLET (7 RPCs) ───

  // Create wallet for new user (called by Profile Service on profile creation).
  rpc CreateWallet (CreateWalletRequest) returns (WalletResponse);

  // Get wallet with balance info.
  rpc GetWallet (GetWalletRequest) returns (WalletResponse);

  // Get wallet transaction history with pagination and filters.
  rpc GetWalletTransactions (GetWalletTransactionsRequest) returns (WalletTransactionsResponse);

  // Credit wallet (refund, promo, referral, compensation). Internal/Admin.
  rpc CreditWallet (CreditWalletRequest) returns (WalletResponse);

  // Get balance only (lightweight for UI header).
  rpc GetBalance (GetBalanceRequest) returns (BalanceResponse);

  // Freeze wallet (fraud prevention).
  rpc FreezeWallet (FreezeWalletRequest) returns (WalletResponse);

  // Unfreeze wallet.
  rpc UnfreezeWallet (UnfreezeWalletRequest) returns (WalletResponse);

  // ─── PAYMENT METHODS (3 RPCs) ───

  // Add tokenized card/Nequi via Wompi.
  rpc AddPaymentMethod (AddPaymentMethodRequest) returns (PaymentMethodResponse);

  // List active payment methods for a client.
  rpc GetPaymentMethods (GetPaymentMethodsRequest) returns (PaymentMethodsResponse);

  // Soft-delete a payment method.
  rpc RemovePaymentMethod (RemovePaymentMethodRequest) returns (PaymentMethodResponse);

  // ─── PAYOUTS (2 RPCs) ───

  // Vet requests payout. Calculates earnings and transfers via Wompi.
  rpc RequestPayout (RequestPayoutRequest) returns (PayoutResponse);

  // Get payout history for a vet with pagination.
  rpc GetPayoutHistory (GetPayoutHistoryRequest) returns (PayoutHistoryResponse);

  // ─── BANK ACCOUNTS & EARNINGS (3 RPCs) ───

  // Register vet bank account (encrypted AES-256-GCM).
  rpc AddBankAccount (AddBankAccountRequest) returns (BankAccountResponse);

  // List vet bank accounts.
  rpc GetBankAccounts (GetBankAccountsRequest) returns (BankAccountsResponse);

  // Get vet earnings summary by period.
  rpc GetVetEarnings (GetVetEarningsRequest) returns (VetEarningsResponse);
}

// ═══════════════════════════════════════════════════════════════════════════
// ENUMS
// ═══════════════════════════════════════════════════════════════════════════

enum PaymentStatus {
  PAYMENT_STATUS_UNSPECIFIED = 0;
  PAYMENT_STATUS_PENDING = 1;
  PAYMENT_STATUS_AUTHORIZED = 2;
  PAYMENT_STATUS_CAPTURED = 3;
  PAYMENT_STATUS_PARTIALLY_REFUNDED = 4;
  PAYMENT_STATUS_REFUNDED = 5;
  PAYMENT_STATUS_FAILED = 6;
  PAYMENT_STATUS_VOIDED = 7;
}

enum PaymentGateway {
  PAYMENT_GATEWAY_UNSPECIFIED = 0;
  PAYMENT_GATEWAY_WOMPI = 1;
  PAYMENT_GATEWAY_WALLET_ONLY = 2;
}

enum WalletOwnerType {
  WALLET_OWNER_TYPE_UNSPECIFIED = 0;
  WALLET_OWNER_TYPE_CLIENT = 1;
  WALLET_OWNER_TYPE_VET = 2;
}

enum WalletTransactionType {
  WALLET_TRANSACTION_TYPE_UNSPECIFIED = 0;
  WALLET_TRANSACTION_TYPE_CREDIT = 1;
  WALLET_TRANSACTION_TYPE_DEBIT = 2;
  WALLET_TRANSACTION_TYPE_HOLD = 3;
  WALLET_TRANSACTION_TYPE_RELEASE = 4;
}

enum WalletTransactionReason {
  WALLET_TRANSACTION_REASON_UNSPECIFIED = 0;
  WALLET_TRANSACTION_REASON_PAYMENT = 1;
  WALLET_TRANSACTION_REASON_REFUND = 2;
  WALLET_TRANSACTION_REASON_REFUND_TO_WALLET = 3;
  WALLET_TRANSACTION_REASON_TIP = 4;
  WALLET_TRANSACTION_REASON_REFERRAL_BONUS = 5;
  WALLET_TRANSACTION_REASON_PROMO_CREDIT = 6;
  WALLET_TRANSACTION_REASON_FIRST_CONSULT_BONUS = 7;
  WALLET_TRANSACTION_REASON_COMPENSATION = 8;
  WALLET_TRANSACTION_REASON_NO_SHOW_FEE = 9;
  WALLET_TRANSACTION_REASON_PAYOUT = 10;
  WALLET_TRANSACTION_REASON_ADMIN_ADJUSTMENT = 11;
  WALLET_TRANSACTION_REASON_HOLD_FOR_PAYMENT = 12;
  WALLET_TRANSACTION_REASON_RELEASE_HOLD = 13;
}

enum WalletReferenceType {
  WALLET_REFERENCE_TYPE_UNSPECIFIED = 0;
  WALLET_REFERENCE_TYPE_PAYMENT = 1;
  WALLET_REFERENCE_TYPE_APPOINTMENT = 2;
  WALLET_REFERENCE_TYPE_PAYOUT = 3;
  WALLET_REFERENCE_TYPE_PROMO = 4;
  WALLET_REFERENCE_TYPE_REFUND = 5;
}

enum PaymentMethodType {
  PAYMENT_METHOD_TYPE_UNSPECIFIED = 0;
  PAYMENT_METHOD_TYPE_CARD = 1;
  PAYMENT_METHOD_TYPE_NEQUI = 2;
}

enum CardBrand {
  CARD_BRAND_UNSPECIFIED = 0;
  CARD_BRAND_VISA = 1;
  CARD_BRAND_MASTERCARD = 2;
  CARD_BRAND_AMEX = 3;
  CARD_BRAND_OTHER = 4;
}

enum BankAccountType {
  BANK_ACCOUNT_TYPE_UNSPECIFIED = 0;
  BANK_ACCOUNT_TYPE_SAVINGS = 1;
  BANK_ACCOUNT_TYPE_CHECKING = 2;
}

enum DocumentType {
  DOCUMENT_TYPE_UNSPECIFIED = 0;
  DOCUMENT_TYPE_CC = 1;
  DOCUMENT_TYPE_CE = 2;
  DOCUMENT_TYPE_NIT = 3;
  DOCUMENT_TYPE_PASSPORT = 4;
}

enum PayoutStatus {
  PAYOUT_STATUS_UNSPECIFIED = 0;
  PAYOUT_STATUS_PENDING = 1;
  PAYOUT_STATUS_PROCESSING = 2;
  PAYOUT_STATUS_COMPLETED = 3;
  PAYOUT_STATUS_FAILED = 4;
}

enum RefundDestination {
  REFUND_DESTINATION_UNSPECIFIED = 0;
  REFUND_DESTINATION_WALLET = 1;
  REFUND_DESTINATION_GATEWAY = 2;
  REFUND_DESTINATION_MIXED = 3;
}

enum RefundReason {
  REFUND_REASON_UNSPECIFIED = 0;
  REFUND_REASON_CLIENT_CANCELLED = 1;
  REFUND_REASON_VET_CANCELLED = 2;
  REFUND_REASON_ADMIN_REFUND = 3;
  REFUND_REASON_SERVICE_ISSUE = 4;
  REFUND_REASON_NO_SHOW_PARTIAL = 5;
  REFUND_REASON_OTHER = 6;
}

enum RefundStatus {
  REFUND_STATUS_UNSPECIFIED = 0;
  REFUND_STATUS_PENDING = 1;
  REFUND_STATUS_PROCESSING = 2;
  REFUND_STATUS_COMPLETED = 3;
  REFUND_STATUS_FAILED = 4;
}

enum AuditEventType {
  AUDIT_EVENT_TYPE_UNSPECIFIED = 0;
  AUDIT_EVENT_TYPE_PAYMENT_CREATED = 1;
  AUDIT_EVENT_TYPE_PAYMENT_AUTHORIZED = 2;
  AUDIT_EVENT_TYPE_PAYMENT_CAPTURED = 3;
  AUDIT_EVENT_TYPE_PAYMENT_VOIDED = 4;
  AUDIT_EVENT_TYPE_PAYMENT_FAILED = 5;
  AUDIT_EVENT_TYPE_REFUND_INITIATED = 6;
  AUDIT_EVENT_TYPE_REFUND_TO_WALLET_COMPLETED = 7;
  AUDIT_EVENT_TYPE_REFUND_TO_GATEWAY_PROCESSING = 8;
  AUDIT_EVENT_TYPE_REFUND_TO_GATEWAY_COMPLETED = 9;
  AUDIT_EVENT_TYPE_REFUND_FAILED = 10;
  AUDIT_EVENT_TYPE_WALLET_CREDITED = 11;
  AUDIT_EVENT_TYPE_WALLET_DEBITED = 12;
  AUDIT_EVENT_TYPE_WALLET_HOLD = 13;
  AUDIT_EVENT_TYPE_WALLET_RELEASE = 14;
  AUDIT_EVENT_TYPE_WALLET_FROZEN = 15;
  AUDIT_EVENT_TYPE_PAYOUT_INITIATED = 16;
  AUDIT_EVENT_TYPE_PAYOUT_COMPLETED = 17;
  AUDIT_EVENT_TYPE_PAYOUT_FAILED = 18;
  AUDIT_EVENT_TYPE_TIP_ADDED = 19;
  AUDIT_EVENT_TYPE_NO_SHOW_FEE_CHARGED = 20;
  AUDIT_EVENT_TYPE_PROMO_CREDIT_ADDED = 21;
  AUDIT_EVENT_TYPE_BANK_ACCOUNT_ADDED = 22;
}

// ═══════════════════════════════════════════════════════════════════════════
// MESSAGES - Core Entities
// ═══════════════════════════════════════════════════════════════════════════

message Payment {
  string id = 1;
  string appointment_id = 2;
  string client_profile_id = 3;
  string vet_profile_id = 4;

  // Amounts
  double amount_subtotal = 5;
  double platform_fee_amount = 6;
  double gateway_fee_amount = 7;
  double vet_payout_amount = 8;
  double amount_total = 9;
  double wallet_amount_used = 10;
  double gateway_amount_charged = 11;
  double tip_amount = 12;

  string currency = 13;
  PaymentStatus status = 14;
  PaymentGateway gateway = 15;

  // Gateway info
  string gateway_transaction_id = 16;
  string gateway_auth_code = 17;

  // Refund tracking
  double refund_total_amount = 18;
  double refund_to_wallet_amount = 19;
  double refund_to_gateway_amount = 20;
  double no_show_fee_amount = 21;

  string idempotency_key = 22;

  // Timestamps
  google.protobuf.Timestamp created_at = 23;
  google.protobuf.Timestamp authorized_at = 24;
  google.protobuf.Timestamp captured_at = 25;
  google.protobuf.Timestamp voided_at = 26;
  google.protobuf.Timestamp refunded_at = 27;
}

message Wallet {
  string id = 1;
  string owner_id = 2;
  WalletOwnerType owner_type = 3;
  double balance = 4;
  double pending_balance = 5;
  double available_balance = 6;
  double total_credited = 7;
  double total_debited = 8;
  string currency = 9;
  bool is_active = 10;
  google.protobuf.Timestamp created_at = 11;
  google.protobuf.Timestamp updated_at = 12;
}

message WalletTransaction {
  string id = 1;
  string wallet_id = 2;
  WalletTransactionType type = 3;
  double amount = 4;
  double balance_before = 5;
  double balance_after = 6;
  WalletTransactionReason reason = 7;
  WalletReferenceType reference_type = 8;
  string reference_id = 9;
  string description = 10;
  google.protobuf.Timestamp created_at = 11;
}

message ClientPaymentMethod {
  string id = 1;
  string client_profile_id = 2;
  PaymentMethodType type = 3;
  CardBrand card_brand = 4;
  string last_four = 5;
  int32 expiry_month = 6;
  int32 expiry_year = 7;
  string holder_name = 8;
  string nequi_phone = 9;
  bool is_default = 10;
  bool is_active = 11;
  google.protobuf.Timestamp created_at = 12;
}

message VetBankAccount {
  string id = 1;
  string vet_profile_id = 2;
  string bank_name = 3;
  BankAccountType account_type = 4;
  string account_number_masked = 5;
  string holder_name = 6;
  DocumentType holder_document_type = 7;
  bool is_verified = 8;
  bool is_primary = 9;
  google.protobuf.Timestamp created_at = 10;
}

message VetPayout {
  string id = 1;
  string vet_profile_id = 2;
  string period_start = 3;
  string period_end = 4;
  int32 total_appointments = 5;
  double total_earnings = 6;
  double total_tips = 7;
  double total_no_show_earnings = 8;
  double net_payout = 9;
  PayoutStatus status = 10;
  string bank_account_id = 11;
  string wompi_transfer_ref = 12;
  google.protobuf.Timestamp processed_at = 13;
  string failed_reason = 14;
  google.protobuf.Timestamp created_at = 15;
}

message Refund {
  string id = 1;
  string payment_id = 2;
  double amount = 3;
  RefundDestination destination = 4;
  double wallet_amount = 5;
  double gateway_amount = 6;
  RefundReason reason = 7;
  string reason_details = 8;
  RefundStatus status = 9;
  string wompi_refund_id = 10;
  string initiated_by = 11;
  string idempotency_key = 12;
  google.protobuf.Timestamp created_at = 13;
  google.protobuf.Timestamp completed_at = 14;
}

// ═══════════════════════════════════════════════════════════════════════════
// MESSAGES - Requests
// ═══════════════════════════════════════════════════════════════════════════

// ─── Payment Lifecycle ───

message CreatePaymentRequest {
  string appointment_id = 1;
  string client_profile_id = 2;
  string vet_profile_id = 3;
  double amount_subtotal = 4;
  string currency = 5;
  string idempotency_key = 6;
}

message AuthorizePaymentRequest {
  string payment_id = 1;
  string payment_method_id = 2;
  string acceptance_token = 3;
  string accept_personal_auth = 4;
  string idempotency_key = 5;
}

message CapturePaymentRequest {
  string payment_id = 1;
  string idempotency_key = 2;
}

message VoidPaymentRequest {
  string payment_id = 1;
  string reason = 2;
  string idempotency_key = 3;
}

message RefundPaymentRequest {
  string payment_id = 1;
  double amount = 2;
  RefundDestination destination = 3;
  RefundReason reason = 4;
  string reason_details = 5;
  string initiated_by = 6;
  string idempotency_key = 7;
}

message ChargeNoShowFeeRequest {
  string payment_id = 1;
  string idempotency_key = 2;
}

message AddTipRequest {
  string payment_id = 1;
  double amount = 2;
  string payment_method_id = 3;
  string idempotency_key = 4;
}

message GetPaymentRequest {
  string payment_id = 1;
}

message GetPaymentByAppointmentRequest {
  string appointment_id = 1;
}

message GetRefundsRequest {
  string payment_id = 1;
}

// ─── Wallet ───

message CreateWalletRequest {
  string owner_id = 1;
  WalletOwnerType owner_type = 2;
}

message GetWalletRequest {
  string owner_id = 1;
  WalletOwnerType owner_type = 2;
}

message GetWalletTransactionsRequest {
  string wallet_id = 1;
  WalletTransactionType type_filter = 2;
  WalletTransactionReason reason_filter = 3;
  int32 limit = 4;
  int32 offset = 5;
}

message CreditWalletRequest {
  string owner_id = 1;
  WalletOwnerType owner_type = 2;
  double amount = 3;
  WalletTransactionReason reason = 4;
  WalletReferenceType reference_type = 5;
  string reference_id = 6;
  string description = 7;
}

message GetBalanceRequest {
  string owner_id = 1;
  WalletOwnerType owner_type = 2;
}

message FreezeWalletRequest {
  string wallet_id = 1;
  string reason = 2;
  string actor_id = 3;
}

message UnfreezeWalletRequest {
  string wallet_id = 1;
  string reason = 2;
  string actor_id = 3;
}

// ─── Payment Methods ───

message AddPaymentMethodRequest {
  string client_profile_id = 1;
  PaymentMethodType type = 2;
  string wompi_token = 3;
  string acceptance_token = 4;
  string accept_personal_auth = 5;
  // Card-specific
  string holder_name = 6;
  // Nequi-specific
  string nequi_phone = 7;
  // Required by Wompi for payment source creation
  string customer_email = 8;
}

message GetPaymentMethodsRequest {
  string client_profile_id = 1;
}

message RemovePaymentMethodRequest {
  string payment_method_id = 1;
  string client_profile_id = 2;
}

// ─── Payouts ───

message RequestPayoutRequest {
  string vet_profile_id = 1;
  string bank_account_id = 2;
}

message GetPayoutHistoryRequest {
  string vet_profile_id = 1;
  int32 limit = 2;
  int32 offset = 3;
}

// ─── Bank Accounts ───

message AddBankAccountRequest {
  string vet_profile_id = 1;
  string bank_name = 2;
  BankAccountType account_type = 3;
  string account_number = 4;
  string holder_name = 5;
  DocumentType holder_document_type = 6;
  string holder_document_number = 7;
  bool is_primary = 8;
}

message GetBankAccountsRequest {
  string vet_profile_id = 1;
}

// ─── Vet Earnings ───

message GetVetEarningsRequest {
  string vet_profile_id = 1;
  string period_start = 2;
  string period_end = 3;
}

// ═══════════════════════════════════════════════════════════════════════════
// MESSAGES - Responses
// ═══════════════════════════════════════════════════════════════════════════

message PaymentResponse {
  Payment payment = 1;
}

message RefundResponse {
  Refund refund = 1;
  Payment payment = 2;
}

message RefundsResponse {
  repeated Refund refunds = 1;
  int32 total_count = 2;
}

message WalletResponse {
  Wallet wallet = 1;
}

message WalletTransactionsResponse {
  repeated WalletTransaction transactions = 1;
  int32 total_count = 2;
}

message BalanceResponse {
  double balance = 1;
  double pending_balance = 2;
  double available_balance = 3;
  string currency = 4;
}

message PaymentMethodResponse {
  ClientPaymentMethod payment_method = 1;
}

message PaymentMethodsResponse {
  repeated ClientPaymentMethod payment_methods = 1;
  int32 total_count = 2;
}

message PayoutResponse {
  VetPayout payout = 1;
}

message PayoutHistoryResponse {
  repeated VetPayout payouts = 1;
  int32 total_count = 2;
}

message BankAccountResponse {
  VetBankAccount bank_account = 1;
}

message BankAccountsResponse {
  repeated VetBankAccount bank_accounts = 1;
  int32 total_count = 2;
}

message VetEarningsResponse {
  string vet_profile_id = 1;
  string period_start = 2;
  string period_end = 3;
  double total_earnings = 4;
  double total_tips = 5;
  double total_no_show_compensation = 6;
  double total_payouts = 7;
  double pending_payout = 8;
  double wallet_balance = 9;
  int32 total_appointments = 10;
}
